<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Alignment test</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>

    <script async src="https://unpkg.com/low-pass-filter"></script>

    <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three/build/three.module.js",
      "low-pass-filter": "https://unpkg.com/low-pass-filter"
    }
  }
</script>
    <link rel="stylesheet" href="index.css">

    <!-- Pollyfill script -->
    <script src="https://unpkg.com/core-js-bundle@3.6.1/minified.js"></script>
    <!-- Live2DCubismCore script -->
    <script src="cubismSDK/Core/live2dcubismcore.js"></script>
    <script src="cubismSDK/bundle.js"></script>

</head>

<body>

    <label for="fps">FPS: </label>
    <div id="fps"></div>
    <div id="video-preview">
        <div>
            <label>Select Camera Source</label>
            <select name="camera-source" id="camera-source"></select>
        </div>
        <div>
            <video height="300" width="400" autoplay="true" id="video-player"></video>
            <canvas height="300" width="400" autoplay="true" id="canvas-preview"></video>
        </div>
    </div>
    <div class="display-3d">
        <div id="display"></div>
        <button id="calibrate">Calibrate</button>
        <pre id="parameters" style="width: 100px ;"></pre>
    </div>

    <div class="canvas-container">

    </div>
</body>
<script src="main.js"></script>
<script async src="facedetect.js" type="module"></script>
<script src="display.js" type="module"></script>
<script async type="module">
    let av1 = null;
    let lb = [0,0,0], rb = [0,0,0];
    let avg = (p,c)=>p+c;
    
    async function loading() {
        try {
            av1 = await loadModel("src/resource/hiyori/Hiyori.model3.json")
            let step = () => {
                if (window.faceXRotation) {
                    lb.push(window.EyeOpenL);
                    lb.shift();
                    rb.push(window.EyeOpenR);
                    rb.shift();
                    let x = ((window.faceXRotation - window.faceXOffset) * (180 / Math.PI)) || 0;
                    let y = ((window.faceYRotation - window.faceYOffset) * (180 / Math.PI)) || 0;
                    let z = ((window.faceZRotation - window.faceZOffset) * (180 / Math.PI)) || 0;
                    if (y > 180) y -= 360;
                    if (x > 180) x -= 360;
                    if (z > 180) z -= 360;
                    av1.character.setMotion(y, -x * 2, -z * 2, 1, window.faceMouthOpen * 10);
                    av1.character.setEyes(y * 0.1, -x * 0.2, lb.reduce(avg) / lb.length, rb.reduce(avg) / rb.length);
                }
                requestAnimationFrame(step);
            }
            requestAnimationFrame(step);

        } catch (err) {
            console.error(err);
            // await loading();
        }
    }

    window.onload = () => {
        window.initFramework();
        loading();
    }



</script>

</html>